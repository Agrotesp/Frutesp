<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FRUTESP â€“ GestÃ£o Operacional</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --g950:#040F0A; --g900:#071A11; --g800:#0B3D2E; --g750:#0D4835;
  --g700:#0F5540; --g650:#12604A; --g600:#156B52; --g500:#1A8060;
  --g400:#20966E; --g300:#2EB87F; --g200:#5FD4A3; --g100:#A8EDD1;
  --surface-card:#0E4838; --surface-hover:#115243; --surface-input:#0A3328;
  --border:rgba(46,184,127,.13); --border-md:rgba(46,184,127,.22); --border-lg:rgba(46,184,127,.38);
  --text1:#E2F5EC; --text2:#9ECFB5; --text3:#5D9B7E; --text4:#3A7059;
  --red:#F06565;    --red-bg:rgba(240,101,101,.15);
  --orange:#F09A55; --or-bg:rgba(240,154,85,.15);
  --yellow:#E0C050; --yl-bg:rgba(224,192,80,.15);
  --blue:#55A9F0;   --bl-bg:rgba(85,169,240,.15);
  --R:14px; --RS:8px; --RX:5px;
  --sh:0 2px 16px rgba(0,0,0,.35); --sh-lg:0 8px 40px rgba(0,0,0,.5);
  --fh:'Syne',sans-serif; --fb:'Figtree',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--fb);background:var(--g800);color:var(--text1);
  min-height:100vh;font-size:15px;-webkit-font-smoothing:antialiased;overscroll-behavior:none}
h1,h2,h3,h4{font-family:var(--fh)} button{font-family:var(--fb)}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--g600);border-radius:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{display:none;min-height:100vh}
.screen.active{display:flex;flex-direction:column}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-login{background:var(--g900);align-items:center;justify-content:center;
  padding:24px;position:relative;overflow:hidden}
.l-orb1{position:absolute;top:-100px;right:-100px;width:400px;height:400px;
  background:radial-gradient(circle,var(--g600) 0%,transparent 70%);opacity:.22;pointer-events:none}
.l-orb2{position:absolute;bottom:-80px;left:-80px;width:300px;height:300px;
  background:radial-gradient(circle,var(--g500) 0%,transparent 70%);opacity:.17;pointer-events:none}
.l-grid{position:absolute;inset:0;
  background-image:linear-gradient(var(--border) 1px,transparent 1px),
    linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:44px 44px;opacity:.35;pointer-events:none}
.login-card{background:var(--g800);border:1px solid var(--border-lg);border-radius:24px;
  padding:40px 32px;width:100%;max-width:400px;box-shadow:var(--sh-lg);
  position:relative;z-index:1;animation:fadeUp .45s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:none}}
.login-logo{text-align:center;margin-bottom:32px}
.logo-mark{width:70px;height:70px;background:linear-gradient(145deg,var(--g600),var(--g300));
  border-radius:20px;display:inline-flex;align-items:center;justify-content:center;
  font-size:34px;margin-bottom:14px;box-shadow:0 8px 28px rgba(46,184,127,.38)}
.login-logo h1{font-size:25px;color:var(--text1);letter-spacing:-.5px}
.login-logo h1 span{color:var(--g300)}
.login-logo p{color:var(--text3);font-size:12.5px;margin-top:4px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fg{margin-bottom:15px}
.fg label{display:block;font-size:11px;font-weight:700;color:var(--text3);
  margin-bottom:7px;text-transform:uppercase;letter-spacing:.7px}
.fg input,.fg select,.fg textarea{width:100%;padding:12px 14px;
  background:var(--surface-input);border:1.5px solid var(--border-md);
  border-radius:var(--RS);color:var(--text1);font-family:var(--fb);font-size:14.5px;
  outline:none;transition:border-color .18s,background .18s}
.fg input::placeholder,.fg textarea::placeholder{color:var(--text4)}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--g300);background:var(--g800)}
.fg select option{background:var(--g700);color:var(--text1)}
.fg textarea{resize:vertical;min-height:76px}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.err-msg{background:var(--red-bg);border:1px solid var(--red);color:var(--red);
  padding:10px 14px;border-radius:var(--RS);font-size:13px;margin-bottom:15px;display:none}
.section-divider{
  display:flex;align-items:center;gap:10px;margin:18px 0 14px;
  font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.7px}
.section-divider::before,.section-divider::after{
  content:'';flex:1;height:1px;background:var(--border-md)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;
  padding:12px 18px;border-radius:var(--RS);font-family:var(--fb);
  font-size:14.5px;font-weight:600;cursor:pointer;border:none;
  transition:all .18s;text-decoration:none;white-space:nowrap}
.btn-p{background:linear-gradient(135deg,var(--g500),var(--g300));color:var(--g950);
  width:100%;box-shadow:0 4px 18px rgba(46,184,127,.32)}
.btn-p:hover{filter:brightness(1.08)}
.btn-p:active{transform:scale(.98)}
.btn-g{background:var(--surface-card);color:var(--text2);border:1px solid var(--border-md)}
.btn-g:hover{background:var(--surface-hover);color:var(--text1)}
.btn-d{background:var(--red-bg);color:var(--red);border:1px solid rgba(240,101,101,.25)}
.btn-d:hover{background:var(--red);color:#fff}
.btn-sm{padding:7px 13px;font-size:13px}
.btn-xs{padding:5px 10px;font-size:12px}
.bico{padding:9px;border-radius:var(--RS);background:var(--surface-card);
  color:var(--text2);cursor:pointer;border:1px solid var(--border);font-size:18px;
  display:inline-flex;align-items:center;justify-content:center;transition:all .18s}
.bico:hover{background:var(--surface-hover);color:var(--text1)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-app{background:var(--g800)}
.topbar{background:var(--g900);border-bottom:1px solid var(--border-md);
  color:var(--text1);padding:0 16px;height:56px;
  display:flex;align-items:center;gap:12px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 16px rgba(0,0,0,.28)}
.tb-logo{font-family:var(--fh);font-size:17px;font-weight:800;
  letter-spacing:-.3px;flex:1}
.tb-logo span{color:var(--g300)}
.tb-sector{font-size:12px;color:var(--text3);background:var(--g800);
  padding:3px 10px;border-radius:20px;border:1px solid var(--border-md)}
.tb-avatar{width:34px;height:34px;background:linear-gradient(135deg,var(--g500),var(--g300));
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:13px;color:var(--g950);cursor:pointer;flex-shrink:0}

.main-content{flex:1;overflow-y:auto;padding-bottom:88px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;
  background:var(--g900);border-top:1px solid var(--border-md);
  display:flex;z-index:100;box-shadow:0 -4px 20px rgba(0,0,0,.4);
  padding-bottom:env(safe-area-inset-bottom,0)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:8px 2px 10px;gap:3px;cursor:pointer;
  border:none;background:transparent;color:var(--text4);font-family:var(--fb);
  font-size:9.5px;font-weight:600;transition:color .2s;position:relative;
  letter-spacing:.3px;text-transform:uppercase}
.nav-icon{font-size:20px}
.nav-item.active{color:var(--g300)}
.nav-badge{position:absolute;top:5px;right:calc(50% - 18px);
  background:var(--red);color:#fff;font-size:9px;font-weight:800;
  min-width:15px;height:15px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;padding:0 3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page{display:none;padding:16px}
.page.active{display:block}
.ph{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-top:4px}
.ph h2{font-size:21px;color:var(--text1);flex:1;letter-spacing:-.3px}
.slbl{font-size:10.5px;font-weight:700;letter-spacing:1.1px;
  text-transform:uppercase;color:var(--text3);margin-bottom:11px;padding-left:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD â€” STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:18px}
.sc{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--R);padding:15px;box-shadow:var(--sh);
  position:relative;overflow:hidden}
.sc::after{content:'';position:absolute;top:0;left:0;right:0;
  height:2.5px;border-radius:2px 2px 0 0}
.sc-g::after{background:linear-gradient(90deg,var(--g400),var(--g200))}
.sc-r::after{background:linear-gradient(90deg,var(--red),#ff9999)}
.sc-o::after{background:linear-gradient(90deg,var(--orange),#ffd0a0)}
.sc-b::after{background:linear-gradient(90deg,var(--blue),#aad6ff)}
.sc-y::after{background:linear-gradient(90deg,var(--yellow),#ffe98a)}
.si{font-size:22px;margin-bottom:7px}
.sv{font-family:var(--fh);font-size:30px;font-weight:800;line-height:1;color:var(--text1)}
.sl{font-size:11px;color:var(--text3);margin-top:3px;font-weight:500}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD â€” AGING PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.aging-panel{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--R);margin-bottom:12px;overflow:hidden}
.aging-header{display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid var(--border)}
.aging-header h4{font-size:13px;color:var(--text1);font-weight:700}
.aging-legend{display:flex;gap:10px;flex-wrap:wrap}
.al-item{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text3)}
.al-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.aging-list{display:flex;flex-direction:column}
.aging-row{
  display:flex;align-items:center;gap:10px;
  padding:11px 16px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .18s;
}
.aging-row:last-child{border-bottom:none}
.aging-row:hover{background:var(--surface-hover)}
.age-indicator{
  width:4px;border-radius:2px;align-self:stretch;flex-shrink:0;min-height:36px}
.age-info{flex:1;min-width:0}
.age-title{font-size:13.5px;font-weight:600;color:var(--text1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.age-sub{font-size:11.5px;color:var(--text3);margin-top:2px}
.age-days{text-align:right;flex-shrink:0}
.age-days-val{font-family:var(--fh);font-size:20px;font-weight:800;line-height:1}
.age-days-lbl{font-size:10px;color:var(--text3)}

/* Aging colors */
.age-0{background:var(--g400)} /* verde: 0-1 dia */
.age-1{background:var(--blue)} /* azul: 2-3 dias */
.age-2{background:var(--yellow)} /* amarelo: 4-7 dias */
.age-3{background:var(--orange)} /* laranja: 8-14 dias */
.age-4{background:var(--red)} /* vermelho: 15+ dias */
.agetext-0{color:var(--g300)}
.agetext-1{color:var(--blue)}
.agetext-2{color:var(--yellow)}
.agetext-3{color:var(--orange)}
.agetext-4{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD â€” CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-card{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--R);padding:16px;box-shadow:var(--sh);margin-bottom:12px}
.chart-card h4{font-size:13px;color:var(--text2);margin-bottom:14px;font-weight:600}
.bar-chart{display:flex;flex-direction:column;gap:11px}
.br{display:flex;align-items:center;gap:10px}
.bl{font-size:12px;color:var(--text3);width:88px;flex-shrink:0}
.bt{flex:1;height:8px;background:var(--g700);border-radius:4px;overflow:hidden}
.bf{height:100%;background:linear-gradient(90deg,var(--g500),var(--g300));
  border-radius:4px;transition:width .9s cubic-bezier(.16,1,.3,1)}
.bv{font-size:12px;font-weight:700;color:var(--text1);width:22px;text-align:right}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filt-row{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;
  margin-bottom:14px;scrollbar-width:none}
.filt-row::-webkit-scrollbar{display:none}
.chip{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;
  border:1.5px solid var(--border-md);background:var(--surface-card);
  color:var(--text3);white-space:nowrap;transition:all .18s}
.chip.active{background:var(--g600);border-color:var(--g400);color:var(--text1)}
.chip:hover:not(.active){background:var(--surface-hover);color:var(--text2)}

.tk-list{display:flex;flex-direction:column;gap:10px}
.tk-card{background:var(--surface-card);border:1px solid var(--border);
  border-left:3.5px solid var(--g400);border-radius:var(--R);
  padding:14px 16px;cursor:pointer;transition:all .2s;box-shadow:var(--sh)}
.tk-card:hover{background:var(--surface-hover);transform:translateY(-1px);box-shadow:var(--sh-lg)}
.tk-card:active{transform:scale(.99)}
.tc-critica{border-left-color:var(--red)}
.tc-alta{border-left-color:var(--orange)}
.tc-media{border-left-color:var(--yellow)}
.tc-baixa{border-left-color:var(--blue)}
.tc-vencido{background:rgba(240,101,101,.05) !important}
.tk-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.tk-proto{font-size:11px;color:var(--text3);font-weight:700;letter-spacing:.5px}
.tk-title{font-size:15px;font-weight:600;color:var(--text1);margin-bottom:8px;line-height:1.35}
.tk-meta{display:flex;flex-wrap:wrap;gap:5px}
.sla-bar{margin-top:10px;height:3px;background:var(--g700);border-radius:2px;overflow:hidden}
.sla-fill{height:100%;border-radius:2px;transition:width .6s}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:3px;
  padding:3px 8px;border-radius:20px;font-size:11px;font-weight:700}
.bs-OPEN{background:var(--bl-bg);color:var(--blue)}
.bs-IN_PROGRESS{background:var(--or-bg);color:var(--orange)}
.bs-WAITING{background:var(--yl-bg);color:var(--yellow)}
.bs-DONE{background:rgba(46,184,127,.15);color:var(--g300)}
.bs-CANCELED{background:rgba(255,255,255,.07);color:var(--text3)}
.bp-critica{background:var(--red-bg);color:var(--red)}
.bp-alta{background:var(--or-bg);color:var(--orange)}
.bp-media{background:var(--yl-bg);color:var(--yellow)}
.bp-baixa{background:var(--bl-bg);color:var(--blue)}
.b-sla{background:var(--red-bg);color:var(--red)}
.b-setor{background:rgba(46,184,127,.12);color:var(--g200)}
.b-cat{background:rgba(85,169,240,.12);color:var(--blue)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKET DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#detail-overlay{display:none;position:fixed;inset:0;
  background:var(--g800);z-index:250;overflow-y:auto;flex-direction:column}
#detail-overlay.open{display:flex}
.dh{background:var(--g900);border-bottom:1px solid var(--border-md);
  padding:12px 16px;display:flex;align-items:center;gap:12px;
  position:sticky;top:0;z-index:10}
.dh h3{flex:1;font-size:15px;color:var(--text1)}
.dbody{flex:1;padding:16px;padding-bottom:100px}
.dsec{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--R);padding:16px;margin-bottom:12px}
.dsec h4{font-size:11px;font-weight:700;color:var(--text3);
  margin-bottom:13px;text-transform:uppercase;letter-spacing:.7px}
.dr{display:flex;justify-content:space-between;align-items:flex-start;
  padding:9px 0;border-bottom:1px solid var(--border)}
.dr:last-child{border-bottom:none;padding-bottom:0}
.drl{font-size:13px;color:var(--text3)}
.drv{font-size:13.5px;font-weight:600;color:var(--text1);text-align:right;max-width:58%}

/* tag list */
.tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tag{background:var(--g700);border:1px solid var(--border-md);
  color:var(--text2);font-size:12px;padding:4px 10px;border-radius:20px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-msgs{display:flex;flex-direction:column;gap:10px;
  padding:12px;min-height:100px;max-height:40vh;overflow-y:auto}
.cmsg{max-width:80%}
.cmsg.mine{align-self:flex-end}
.cmsg.other{align-self:flex-start}
.cbub{padding:10px 14px;border-radius:14px;font-size:14px;line-height:1.45}
.cmsg.mine .cbub{background:linear-gradient(135deg,var(--g600),var(--g500));
  color:var(--text1);border-bottom-right-radius:4px}
.cmsg.other .cbub{background:var(--g700);color:var(--text1);
  border:1px solid var(--border-md);border-bottom-left-radius:4px}
.cmeta{font-size:10px;color:var(--text4);margin-top:3px;padding:0 4px}
.cmsg.mine .cmeta{text-align:right}
.chat-inp-row{display:flex;gap:8px;align-items:flex-end;padding:12px 16px;
  background:var(--g900);border-top:1px solid var(--border-md);position:sticky;bottom:0}
.chat-inp-row textarea{flex:1;padding:10px 14px;background:var(--g800);
  border:1.5px solid var(--border-md);border-radius:20px;color:var(--text1);
  font-family:var(--fb);font-size:14px;resize:none;max-height:100px;outline:none;
  transition:border-color .2s}
.chat-inp-row textarea:focus{border-color:var(--g400)}
.chat-inp-row textarea::placeholder{color:var(--text4)}
.send-btn{width:40px;height:40px;background:linear-gradient(135deg,var(--g500),var(--g300));
  color:var(--g950);border:none;border-radius:50%;font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  box-shadow:0 4px 14px rgba(46,184,127,.32);transition:all .18s}
.send-btn:hover{filter:brightness(1.1)}

/* Sector chat */
.stabs{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;
  margin-bottom:14px;scrollbar-width:none}
.stabs::-webkit-scrollbar{display:none}
.stab{padding:7px 14px;border-radius:20px;font-size:12px;font-weight:600;
  cursor:pointer;border:1.5px solid var(--border-md);background:var(--surface-card);
  color:var(--text3);white-space:nowrap;transition:all .18s}
.stab.active{background:var(--g600);border-color:var(--g400);color:var(--text1)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EQUIPMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.eq-card{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--R);padding:14px 16px;margin-bottom:10px;
  display:flex;align-items:center;gap:14px;cursor:pointer;
  box-shadow:var(--sh);transition:all .2s}
.eq-card:hover{background:var(--surface-hover);transform:translateY(-1px)}
.eq-icon{width:48px;height:48px;background:var(--g700);border:1px solid var(--border-md);
  border-radius:13px;display:flex;align-items:center;justify-content:center;
  font-size:22px;flex-shrink:0}
.eq-name{font-weight:600;font-size:15px;color:var(--text1)}
.eq-sub{font-size:12px;color:var(--text3);margin-top:2px}
.es{font-size:11px;font-weight:700;padding:3px 9px;border-radius:10px}
.es-a{background:rgba(46,184,127,.15);color:var(--g300)}
.es-m{background:var(--or-bg);color:var(--orange)}
.es-i{background:rgba(255,255,255,.07);color:var(--text3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRONES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.drone-hero{background:linear-gradient(135deg,var(--g700),var(--g600));
  border:1px solid var(--border-lg);border-radius:var(--R);
  padding:20px;margin-bottom:16px;display:flex;align-items:center;gap:16px;
  position:relative;overflow:hidden}
.drone-hero::before{content:'';position:absolute;top:-30px;right:-30px;
  width:150px;height:150px;
  background:radial-gradient(circle,var(--g300) 0%,transparent 70%);
  opacity:.14;pointer-events:none}
.drone-hero-icon{font-size:46px}
.drone-hero-info h3{font-size:17px;color:var(--text1);margin-bottom:4px}
.drone-hero-info p{font-size:13px;color:var(--text3)}
.drone-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.drs{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--RS);padding:12px 10px;text-align:center}
.drs-v{font-family:var(--fh);font-size:22px;font-weight:800;color:var(--g300)}
.drs-l{font-size:10px;color:var(--text3);font-weight:600;
  letter-spacing:.5px;text-transform:uppercase;margin-top:2px}
.dr-card{background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--R);padding:16px;margin-bottom:10px;
  box-shadow:var(--sh);cursor:pointer;transition:all .2s}
.dr-card:hover{background:var(--surface-hover)}
.drc-top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.dr-avatar{width:46px;height:46px;border-radius:12px;
  background:linear-gradient(135deg,var(--g600),var(--g400));
  display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.dr-name{font-weight:700;font-size:15px;color:var(--text1)}
.dr-code{font-size:12px;color:var(--text3);margin-top:2px}
.dr-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.drm{background:var(--g700);border-radius:var(--RX);padding:8px 10px}
.drm-l{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.4px}
.drm-v{font-size:13px;font-weight:600;color:var(--text1);margin-top:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRONE DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#drone-overlay{display:none;position:fixed;inset:0;
  background:var(--g800);z-index:250;overflow-y:auto;flex-direction:column}
#drone-overlay.open{display:flex}
.ms-card{background:var(--g700);border:1px solid var(--border);
  border-radius:var(--RS);padding:12px 14px;margin-bottom:8px;
  display:flex;align-items:center;gap:12px}
.ms-ico{font-size:20px;width:32px;text-align:center;flex-shrink:0}
.ms-info{flex:1}
.ms-ttl{font-size:13.5px;font-weight:600;color:var(--text1)}
.ms-sub{font-size:11.5px;color:var(--text3);margin-top:2px}
.ms-st{font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px}
.ms-planned{background:var(--bl-bg);color:var(--blue)}
.ms-active{background:rgba(46,184,127,.15);color:var(--g300)}
.ms-done{background:rgba(255,255,255,.07);color:var(--text3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-bg{display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.65);z-index:300;align-items:flex-end;
  backdrop-filter:blur(3px)}
.modal-bg.open{display:flex}
.modal-sheet{background:var(--g750);border:1px solid var(--border-md);
  border-radius:20px 20px 0 0;padding:20px 20px 48px;
  width:100%;max-height:92vh;overflow-y:auto;
  animation:slideUp .28s cubic-bezier(.16,1,.3,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:none}}
.mhandle{width:40px;height:4px;background:var(--border-md);
  border-radius:2px;margin:0 auto 20px}
.mtitle{font-size:18px;color:var(--text1);margin-bottom:20px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fab{position:fixed;bottom:80px;right:16px;width:52px;height:52px;
  background:linear-gradient(135deg,var(--g500),var(--g300));color:var(--g950);
  border:none;border-radius:50%;font-size:28px;cursor:pointer;
  box-shadow:0 4px 22px rgba(46,184,127,.48);
  display:flex;align-items:center;justify-content:center;z-index:99;
  transition:all .2s;font-weight:300}
.fab:hover{filter:brightness(1.1);transform:scale(1.05)}
.fab:active{transform:scale(.97)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:92px;left:50%;
  transform:translateX(-50%) translateY(12px);
  background:var(--g600);border:1px solid var(--border-lg);
  color:var(--text1);padding:11px 20px;border-radius:10px;
  font-size:14px;font-weight:500;z-index:999;opacity:0;
  transition:all .28s;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pf-banner{background:linear-gradient(135deg,var(--g700),var(--g600));
  border:1px solid var(--border-lg);border-radius:var(--R);
  padding:24px 20px;margin-bottom:16px;display:flex;align-items:center;gap:16px;
  position:relative;overflow:hidden}
.pf-banner::after{content:'ğŸŒ¿';position:absolute;right:20px;top:50%;
  transform:translateY(-50%);font-size:60px;opacity:.12}
.pf-av{width:58px;height:58px;
  background:linear-gradient(135deg,var(--g400),var(--g200));border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--fh);font-size:22px;font-weight:700;color:var(--g950);flex-shrink:0}
.pf-name{font-size:18px;font-weight:700;color:var(--text1)}
.pf-role{font-size:13px;color:var(--text3);margin-top:3px}
.pf-email{font-size:12px;color:var(--text4);margin-top:2px}
.menu-item{display:flex;align-items:center;gap:14px;
  background:var(--surface-card);border:1px solid var(--border);
  border-radius:var(--RS);padding:14px 16px;margin-bottom:8px;cursor:pointer;
  box-shadow:var(--sh);transition:all .18s;width:100%;text-align:left}
.menu-item:hover{background:var(--surface-hover);border-color:var(--border-md)}
.mi-icon{font-size:20px;width:28px;text-align:center}
.mi-label{flex:1;font-size:15px;font-weight:500;color:var(--text1)}
.mi-arrow{color:var(--text4);font-size:18px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.log-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.log-item:last-child{border-bottom:none}
.log-dot{width:9px;height:9px;background:var(--g400);border-radius:50%;
  margin-top:5px;flex-shrink:0}
.log-act{font-size:13px;font-weight:600;color:var(--text1)}
.log-det{font-size:12px;color:var(--text3);margin-top:2px}
.log-t{font-size:11px;color:var(--text4)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.action-bar{position:sticky;bottom:0;background:var(--g900);
  border-top:1px solid var(--border-md);padding:12px 16px;
  display:flex;gap:10px;z-index:10}
.action-bar .btn{flex:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{text-align:center;padding:46px 20px;color:var(--text3)}
.empty-icon{font-size:50px;margin-bottom:14px;opacity:.7}
.empty p{font-size:14px;line-height:1.5}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF REPORT PRINT STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  body { background: white !important; color: #1a1a1a !important; font-size: 12px; }
  .no-print { display: none !important; }
  .print-only { display: block !important; }
  #pdf-report { display: block !important; }
  .pdf-page { page-break-after: always; padding: 20px; }
  .pdf-page:last-child { page-break-after: auto; }
  .pdf-h1 { font-family: var(--fh); font-size: 22px; color: #0B3D2E; margin-bottom: 4px; }
  .pdf-sub { font-size: 12px; color: #666; margin-bottom: 24px; }
  .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
  .pdf-table th { background: #0B3D2E; color: white; padding: 8px 10px; text-align: left; }
  .pdf-table td { padding: 7px 10px; border-bottom: 1px solid #ddd; }
  .pdf-table tr:nth-child(even) td { background: #f5f5f5; }
  .pdf-stats-row { display: flex; gap: 16px; margin-bottom: 20px; }
  .pdf-stat { flex: 1; background: #e8f5ef; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #0B3D2E; }
  .pdf-stat-v { font-size: 24px; font-weight: 800; color: #0B3D2E; }
  .pdf-stat-l { font-size: 11px; color: #555; margin-top: 2px; }
  .pdf-section-title { font-size: 14px; font-weight: 700; color: #0B3D2E; margin-bottom: 10px; border-bottom: 2px solid #0B3D2E; padding-bottom: 4px; }
}

/* PDF REPORT (hidden until print) */
#pdf-report { display: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:600px){
  .stats-grid{grid-template-columns:repeat(3,1fr)}
  .main-content{max-width:680px;margin:0 auto}
  .bottom-nav{max-width:680px;left:50%;right:auto;transform:translateX(-50%)}
  .fab{right:calc(50% - 340px + 16px)}
  .modal-sheet{max-width:680px;margin:0 auto}
  .toast{left:50%}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="screen active">
  <div class="l-orb1"></div><div class="l-orb2"></div><div class="l-grid"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="logo-mark">ğŸŒ¿</div>
      <h1>FRUTE<span>SP</span></h1>
      <p>GestÃ£o Operacional</p>
    </div>
    <div id="login-err" class="err-msg">E-mail ou senha incorretos.</div>
    <div class="fg">
      <label>E-mail</label>
      <input type="email" id="inp-email" value="maykons@frutesp.com">
    </div>
    <div class="fg">
      <label>Senha</label>
      <input type="password" id="inp-senha" value="#Mds2026"
        onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn btn-p" onclick="doLogin()" style="margin-top:6px">Entrar</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â• -->
<div id="screen-app" class="screen">
  <div class="topbar">
    <div class="tb-logo">FRUTE<span>SP</span></div>
    <div class="tb-sector" id="tb-setor"></div>
    <div class="tb-avatar" id="tb-avatar" onclick="navTo('perfil')"></div>
  </div>

  <div class="main-content">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="ph">
        <h2 id="dash-title">Dashboard</h2>
        <button class="btn btn-g btn-sm" onclick="gerarRelatorio()" id="btn-relatorio" style="display:none">
          ğŸ“„ RelatÃ³rio PDF
        </button>
      </div>
      <div class="stats-grid" id="stats-grid"></div>

      <!-- AGING PANEL â€” gestor only -->
      <div id="aging-section" style="display:none">
        <div class="slbl">â³ Chamados em aberto â€” Tempo decorrido</div>
        <div class="aging-panel">
          <div class="aging-header">
            <h4>Painel de Aging</h4>
            <div class="aging-legend">
              <div class="al-item"><div class="al-dot age-0"></div>0â€“1 dia</div>
              <div class="al-item"><div class="al-dot age-1"></div>2â€“3 dias</div>
              <div class="al-item"><div class="al-dot age-2"></div>4â€“7 dias</div>
              <div class="al-item"><div class="al-dot age-3"></div>8â€“14 dias</div>
              <div class="al-item"><div class="al-dot age-4"></div>15+ dias</div>
            </div>
          </div>
          <div class="aging-list" id="aging-list"></div>
        </div>
      </div>

      <div class="slbl">Chamados por Setor</div>
      <div class="chart-card"><div class="bar-chart" id="bar-setor"></div></div>
      <div class="slbl">Equipamentos com mais ocorrÃªncias</div>
      <div class="chart-card"><div class="bar-chart" id="bar-equip"></div></div>
      <div class="slbl">DistribuiÃ§Ã£o por Prioridade</div>
      <div class="chart-card"><div class="bar-chart" id="bar-prio"></div></div>
    </div>

    <!-- TICKETS -->
    <div id="page-tickets" class="page">
      <div class="ph">
        <h2>Chamados</h2>
        <span id="tc-count" class="badge bs-OPEN"></span>
      </div>
      <div class="filt-row">
        <div class="chip active" onclick="filterTk('todos',this)">Todos</div>
        <div class="chip" onclick="filterTk('OPEN',this)">Abertos</div>
        <div class="chip" onclick="filterTk('IN_PROGRESS',this)">Em Andamento</div>
        <div class="chip" onclick="filterTk('WAITING',this)">Aguardando</div>
        <div class="chip" onclick="filterTk('DONE',this)">ConcluÃ­dos</div>
        <div class="chip" onclick="filterTk('sla',this)">âš ï¸ SLA Vencido</div>
      </div>
      <div class="tk-list" id="ticket-list"></div>
    </div>

    <!-- CHAT -->
    <div id="page-chat" class="page" style="padding:16px 16px 0">
      <div class="ph"><h2>Chat por Setor</h2></div>
      <div class="stabs" id="sector-tabs"></div>
      <div class="chat-msgs" id="sector-msgs" style="max-height:55vh;padding:0"></div>
      <div class="chat-inp-row" style="position:sticky;bottom:68px;margin:0 -16px">
        <textarea id="sector-input" placeholder="Mensagem..." rows="1"></textarea>
        <button class="send-btn" onclick="sendSectorMsg()">â¤</button>
      </div>
    </div>

    <!-- EQUIPAMENTOS -->
    <div id="page-equip" class="page">
      <div class="ph">
        <h2>Equipamentos</h2>
        <button class="btn btn-g btn-sm" onclick="openModal('modal-equip')">+ Novo</button>
      </div>
      <div id="equip-list"></div>
    </div>

    <!-- DRONES -->
    <div id="page-drones" class="page">
      <div class="ph">
        <h2>Drones</h2>
        <button class="btn btn-g btn-sm" onclick="openModal('modal-drone')">+ Novo</button>
      </div>
      <div class="drone-hero">
        <div class="drone-hero-icon">ğŸš</div>
        <div class="drone-hero-info">
          <h3>Frota de Drones</h3>
          <p>Monitoramento e missÃµes agrÃ­colas</p>
        </div>
      </div>
      <div class="drone-stats">
        <div class="drs"><div class="drs-v" id="ds-total">0</div><div class="drs-l">Drones</div></div>
        <div class="drs"><div class="drs-v" id="ds-voos">0</div><div class="drs-l">MissÃµes</div></div>
        <div class="drs"><div class="drs-v" id="ds-ha">0</div><div class="drs-l">ha Cob.</div></div>
      </div>
      <div class="slbl">Frota Cadastrada</div>
      <div id="drone-list"></div>
    </div>

    <!-- PERFIL -->
    <div id="page-perfil" class="page">
      <div class="pf-banner">
        <div class="pf-av" id="pf-avatar"></div>
        <div>
          <div class="pf-name" id="pf-name"></div>
          <div class="pf-role" id="pf-role"></div>
          <div class="pf-email" id="pf-email"></div>
        </div>
      </div>
      <div class="slbl">Menu</div>
      <button class="menu-item" onclick="openModal('modal-user')">
        <span class="mi-icon">ğŸ‘¥</span><span class="mi-label">Gerenciar UsuÃ¡rios</span><span class="mi-arrow">â€º</span>
      </button>
      <button class="menu-item" onclick="showToast('Setores: em breve na versÃ£o com backend!')">
        <span class="mi-icon">ğŸ­</span><span class="mi-label">Setores & Locais</span><span class="mi-arrow">â€º</span>
      </button>
      <button class="menu-item" onclick="showSLAConfig()">
        <span class="mi-icon">â±</span><span class="mi-label">Configurar SLA</span><span class="mi-arrow">â€º</span>
      </button>
      <button class="menu-item" onclick="gerarRelatorio()">
        <span class="mi-icon">ğŸ“Š</span><span class="mi-label">RelatÃ³rio PDF Completo</span><span class="mi-arrow">â€º</span>
      </button>
      <button class="menu-item" onclick="doLogout()">
        <span class="mi-icon">ğŸšª</span><span class="mi-label">Sair</span><span class="mi-arrow">â€º</span>
      </button>
    </div>

  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="navTo('dashboard')">
      <span class="nav-icon">ğŸ“Š</span>Dashboard
    </button>
    <button class="nav-item" onclick="navTo('tickets')">
      <span class="nav-icon">ğŸ“‹</span>Chamados
      <span class="nav-badge" id="nav-badge" style="display:none"></span>
    </button>
    <button class="nav-item" onclick="navTo('chat')">
      <span class="nav-icon">ğŸ’¬</span>Chat
    </button>
    <button class="nav-item" onclick="navTo('drones')">
      <span class="nav-icon">ğŸš</span>Drones
    </button>
    <button class="nav-item" onclick="navTo('equip')">
      <span class="nav-icon">ğŸ”§</span>Equip.
    </button>
    <button class="nav-item" onclick="navTo('perfil')">
      <span class="nav-icon">ğŸ‘¤</span>Perfil
    </button>
  </nav>

  <button class="fab" id="fab" onclick="openModal('modal-ticket')">+</button>
</div>

<!-- â•â•â•â•â•â•â•â• TICKET DETAIL â•â•â•â•â•â•â•â• -->
<div id="detail-overlay">
  <div class="dh">
    <button class="bico" style="background:var(--g700);color:var(--text1)" onclick="closeDetail()">â†</button>
    <h3 id="dh-proto">Chamado</h3>
    <div id="dh-badge"></div>
  </div>
  <div class="dbody">
    <div class="dsec">
      <h4>InformaÃ§Ãµes Gerais</h4>
      <div class="dr"><span class="drl">TÃ­tulo</span><span class="drv" id="d-titulo"></span></div>
      <div class="dr"><span class="drl">Categoria</span><span class="drv" id="d-cat"></span></div>
      <div class="dr"><span class="drl">Tipo de Problema</span><span class="drv" id="d-tipo-prob"></span></div>
      <div class="dr"><span class="drl">Prioridade</span><span class="drv" id="d-pri"></span></div>
      <div class="dr"><span class="drl">Setor</span><span class="drv" id="d-setor"></span></div>
      <div class="dr"><span class="drl">Local</span><span class="drv" id="d-local"></span></div>
      <div class="dr"><span class="drl">Impacto</span><span class="drv" id="d-impacto"></span></div>
      <div class="dr"><span class="drl">Parada (min)</span><span class="drv" id="d-parada"></span></div>
    </div>
    <div class="dsec" id="d-sec-maquina" style="display:none">
      <h4>ğŸ”§ MÃ¡quina / Equipamento com Problema</h4>
      <div class="dr"><span class="drl">Equipamento</span><span class="drv" id="d-equip-prob"></span></div>
      <div class="dr"><span class="drl">Falha Identificada</span><span class="drv" id="d-falha"></span></div>
      <div id="d-comp-area"></div>
    </div>
    <div class="dsec" id="d-sec-materiais" style="display:none">
      <h4>ğŸ“¦ Materiais / Produtos NecessÃ¡rios</h4>
      <div id="d-mat-list"></div>
    </div>
    <div class="dsec">
      <h4>DescriÃ§Ã£o</h4>
      <p style="font-size:14px;color:var(--text2);line-height:1.6" id="d-desc"></p>
    </div>
    <div class="dsec">
      <h4>Datas & SLA</h4>
      <div class="dr"><span class="drl">Abertura</span><span class="drv" id="d-abertura"></span></div>
      <div class="dr"><span class="drl">Dias em aberto</span><span class="drv" id="d-dias"></span></div>
      <div class="dr"><span class="drl">Prazo SLA</span><span class="drv" id="d-sla"></span></div>
      <div class="dr"><span class="drl">ResponsÃ¡vel</span><span class="drv" id="d-resp"></span></div>
      <div class="dr"><span class="drl">Solicitante</span><span class="drv" id="d-sol"></span></div>
    </div>
    <div class="dsec" style="padding-bottom:0">
      <h4>Mensagens</h4>
      <div class="chat-msgs" id="ticket-msgs" style="padding:0;min-height:80px"></div>
    </div>
    <div class="chat-inp-row" style="margin:0 -16px">
      <textarea id="ticket-chat-inp" placeholder="Responder..." rows="1"></textarea>
      <button class="send-btn" onclick="sendTicketMsg()">â¤</button>
    </div>
    <div class="dsec" style="margin-top:12px">
      <h4>HistÃ³rico de AlteraÃ§Ãµes</h4>
      <div id="tk-history"></div>
    </div>
  </div>
  <div class="action-bar" id="tk-actions"></div>
</div>

<!-- â•â•â•â•â•â•â•â• DRONE DETAIL â•â•â•â•â•â•â•â• -->
<div id="drone-overlay">
  <div class="dh">
    <button class="bico" style="background:var(--g700);color:var(--text1)" onclick="closeDroneDetail()">â†</button>
    <h3 id="dro-name">Drone</h3>
    <div id="dro-badge"></div>
  </div>
  <div class="dbody">
    <div class="dsec">
      <h4>EspecificaÃ§Ãµes</h4>
      <div class="dr"><span class="drl">Modelo</span><span class="drv" id="dro-modelo"></span></div>
      <div class="dr"><span class="drl">CÃ³digo</span><span class="drv" id="dro-codigo"></span></div>
      <div class="dr"><span class="drl">Setor</span><span class="drv" id="dro-setor"></span></div>
      <div class="dr"><span class="drl">Capacidade</span><span class="drv" id="dro-cap"></span></div>
      <div class="dr"><span class="drl">Horas de Voo</span><span class="drv" id="dro-horas"></span></div>
      <div class="dr"><span class="drl">Ãrea Total (ha)</span><span class="drv" id="dro-ha"></span></div>
      <div class="dr"><span class="drl">Ãšltima ManutenÃ§Ã£o</span><span class="drv" id="dro-mnt"></span></div>
      <div class="dr"><span class="drl">PrÃ³xima ManutenÃ§Ã£o</span><span class="drv" id="dro-prox"></span></div>
    </div>
    <div class="dsec">
      <h4>MissÃµes</h4>
      <div id="dro-missions"></div>
    </div>
    <div style="padding:0 0 12px;display:flex;gap:10px">
      <button class="btn btn-g" style="flex:1" onclick="openMissionModal()">+ Nova MissÃ£o</button>
      <button class="btn btn-d" style="flex:1" onclick="deleteDrone()">Excluir Drone</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â• -->

<!-- NOVO CHAMADO -->
<div class="modal-bg" id="modal-ticket">
  <div class="modal-sheet">
    <div class="mhandle"></div>
    <div class="mtitle">ğŸ« Novo Chamado</div>

    <div class="fg"><label>TÃ­tulo</label>
      <input type="text" id="nt-titulo" placeholder="Descreva brevemente o problema"></div>
    <div class="fg"><label>DescriÃ§Ã£o detalhada</label>
      <textarea id="nt-desc" placeholder="Detalhes do problema..."></textarea></div>
    <div class="frow">
      <div class="fg"><label>Categoria</label>
        <select id="nt-cat">
          <option>Corretiva</option><option>Preventiva</option>
          <option>Emergencial</option><option>Administrativa</option>
        </select></div>
      <div class="fg"><label>Prioridade</label>
        <select id="nt-pri">
          <option value="baixa">Baixa</option><option value="media">MÃ©dia</option>
          <option value="alta">Alta</option><option value="critica">CrÃ­tica</option>
        </select></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Setor</label>
        <select id="nt-setor">
          <option>ProduÃ§Ã£o</option><option>MecÃ¢nica</option>
          <option>IrrigaÃ§Ã£o</option><option>Packing House</option><option>Administrativo</option>
        </select></div>
      <div class="fg"><label>Local</label>
        <select id="nt-local">
          <option>TalhÃ£o A</option><option>TalhÃ£o B</option><option>TalhÃ£o C</option>
          <option>Packing</option><option>Oficina</option><option>EscritÃ³rio</option>
          <option>Ãrea de IrrigaÃ§Ã£o</option><option>GalpÃ£o</option>
        </select></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Impacto Operacional</label>
        <select id="nt-impacto"><option>Baixo</option><option>MÃ©dio</option><option>Alto</option></select></div>
      <div class="fg"><label>Parada (min)</label>
        <input type="number" id="nt-parada" value="0" min="0"></div>
    </div>

    <!-- TIPO DE PROBLEMA -->
    <div class="fg"><label>Tipo de Problema</label>
      <select id="nt-tipo-prob" onchange="toggleProblemSections()">
        <option value="maquina">ğŸ”§ MÃ¡quina / Equipamento com falha</option>
        <option value="material">ğŸ“¦ Necessidade de material / produto</option>
        <option value="ambos">ğŸ”§ğŸ“¦ Ambos (mÃ¡quina + materiais)</option>
        <option value="outro">ğŸ“‹ Outro / Administrativo</option>
      </select></div>

    <!-- SEÃ‡ÃƒO MÃQUINA -->
    <div id="sec-maquina">
      <div class="section-divider">ğŸ”§ MÃ¡quina / Equipamento com Falha</div>
      <div class="fg"><label>Equipamento com problema</label>
        <select id="nt-equip-prob"><option value="">-- Selecione --</option></select></div>
      <div class="fg"><label>DescriÃ§Ã£o da Falha</label>
        <input type="text" id="nt-falha" placeholder="Ex: Motor nÃ£o liga, vazamento no bico..."></div>
      <div class="fg"><label>Componentes / PeÃ§as necessÃ¡rias</label>
        <input type="text" id="nt-componentes" placeholder="Ex: Filtro de ar, correia, vedaÃ§Ã£o..."></div>
    </div>

    <!-- SEÃ‡ÃƒO MATERIAIS -->
    <div id="sec-materiais" style="display:none">
      <div class="section-divider">ğŸ“¦ Materiais / Produtos NecessÃ¡rios</div>
      <div id="mat-rows">
        <div class="mat-row frow" style="margin-bottom:8px">
          <div class="fg" style="margin-bottom:0"><label>Item / Produto</label>
            <input type="text" class="mat-nome" placeholder="Ex: Herbicida, Adubo..."></div>
          <div class="fg" style="margin-bottom:0"><label>Qtd / Unid.</label>
            <input type="text" class="mat-qtd" placeholder="Ex: 5 L, 2 kg"></div>
        </div>
      </div>
      <button class="btn btn-g btn-sm" style="width:100%;margin-bottom:4px" onclick="addMatRow()">+ Adicionar item</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn btn-g" style="flex:1" onclick="closeModal('modal-ticket')">Cancelar</button>
      <button class="btn btn-p" style="flex:2" onclick="submitTicket()">Abrir Chamado</button>
    </div>
  </div>
</div>

<!-- EQUIP -->
<div class="modal-bg" id="modal-equip">
  <div class="modal-sheet">
    <div class="mhandle"></div>
    <div class="mtitle">ğŸ”§ Novo Equipamento</div>
    <div class="fg"><label>Nome</label><input type="text" id="eq-nome" placeholder="Ex: Trator John Deere"></div>
    <div class="frow">
      <div class="fg"><label>CÃ³digo</label><input type="text" id="eq-cod" placeholder="TR-001"></div>
      <div class="fg"><label>Tipo</label>
        <select id="eq-tipo">
          <option>Trator</option><option>Pulverizador</option><option>Bomba</option>
          <option>Esteira</option><option>Compressor</option><option>VeÃ­culo</option><option>Outro</option>
        </select></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Setor</label>
        <select id="eq-setor">
          <option>ProduÃ§Ã£o</option><option>MecÃ¢nica</option>
          <option>IrrigaÃ§Ã£o</option><option>Packing House</option><option>Administrativo</option>
        </select></div>
      <div class="fg"><label>Local</label>
        <select id="eq-local">
          <option>TalhÃ£o A</option><option>TalhÃ£o B</option><option>Packing</option>
          <option>Oficina</option><option>GalpÃ£o</option>
        </select></div>
    </div>
    <div class="frow">
      <div class="fg"><label>HorÃ­metro (h)</label><input type="number" id="eq-hor" value="0" min="0"></div>
      <div class="fg"><label>Status</label>
        <select id="eq-status">
          <option value="ativo">Ativo</option>
          <option value="manutencao">Em ManutenÃ§Ã£o</option>
          <option value="inativo">Inativo</option>
        </select></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Ãšlt. Preventiva</label><input type="date" id="eq-ultp"></div>
      <div class="fg"><label>PrÃ³x. Preventiva</label><input type="date" id="eq-proxp"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-g" style="flex:1" onclick="closeModal('modal-equip')">Cancelar</button>
      <button class="btn btn-p" style="flex:2" onclick="submitEquip()">Cadastrar</button>
    </div>
  </div>
</div>

<!-- DRONE -->
<div class="modal-bg" id="modal-drone">
  <div class="modal-sheet">
    <div class="mhandle"></div>
    <div class="mtitle">ğŸš Novo Drone</div>
    <div class="fg"><label>Nome / Apelido</label><input type="text" id="dr-nome" placeholder="Ex: Drone Alpha"></div>
    <div class="frow">
      <div class="fg"><label>Modelo</label><input type="text" id="dr-modelo" placeholder="DJI Agras T40"></div>
      <div class="fg"><label>CÃ³digo</label><input type="text" id="dr-cod" placeholder="DR-001"></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Setor</label>
        <select id="dr-setor">
          <option>ProduÃ§Ã£o</option><option>IrrigaÃ§Ã£o</option>
          <option>Packing House</option><option>GestÃ£o</option>
        </select></div>
      <div class="fg"><label>Capacidade (L)</label><input type="number" id="dr-cap" value="0" min="0"></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Horas de Voo</label><input type="number" id="dr-horas" value="0" min="0"></div>
      <div class="fg"><label>Ãrea total (ha)</label><input type="number" id="dr-ha" value="0" min="0"></div>
    </div>
    <div class="fg"><label>Status</label>
      <select id="dr-status">
        <option value="disponivel">DisponÃ­vel</option>
        <option value="em_voo">Em Voo</option>
        <option value="manutencao">ManutenÃ§Ã£o</option>
        <option value="inativo">Inativo</option>
      </select></div>
    <div class="frow">
      <div class="fg"><label>Ãšlt. ManutenÃ§Ã£o</label><input type="date" id="dr-mnt"></div>
      <div class="fg"><label>PrÃ³x. ManutenÃ§Ã£o</label><input type="date" id="dr-proxmnt"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-g" style="flex:1" onclick="closeModal('modal-drone')">Cancelar</button>
      <button class="btn btn-p" style="flex:2" onclick="submitDrone()">Cadastrar</button>
    </div>
  </div>
</div>

<!-- MISSION -->
<div class="modal-bg" id="modal-mission">
  <div class="modal-sheet">
    <div class="mhandle"></div>
    <div class="mtitle">âœˆï¸ Nova MissÃ£o</div>
    <div class="fg"><label>TÃ­tulo da MissÃ£o</label>
      <input type="text" id="ms-titulo" placeholder="Ex: PulverizaÃ§Ã£o TalhÃ£o B"></div>
    <div class="frow">
      <div class="fg"><label>Tipo</label>
        <select id="ms-tipo">
          <option>PulverizaÃ§Ã£o</option><option>Monitoramento</option>
          <option>Mapeamento</option><option>IrrigaÃ§Ã£o</option><option>Outro</option>
        </select></div>
      <div class="fg"><label>Ãrea (ha)</label>
        <input type="number" id="ms-ha" value="0" min="0"></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Data</label><input type="date" id="ms-data"></div>
      <div class="fg"><label>DuraÃ§Ã£o (min)</label><input type="number" id="ms-dur" value="0" min="0"></div>
    </div>
    <div class="fg"><label>Status</label>
      <select id="ms-status">
        <option value="planned">Planejado</option>
        <option value="active">Em ExecuÃ§Ã£o</option>
        <option value="done">ConcluÃ­do</option>
      </select></div>
    <div class="fg"><label>ObservaÃ§Ãµes</label>
      <textarea id="ms-obs" placeholder="Produto utilizado, condiÃ§Ãµes, etc..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-g" style="flex:1" onclick="closeModal('modal-mission')">Cancelar</button>
      <button class="btn btn-p" style="flex:2" onclick="submitMission()">Registrar</button>
    </div>
  </div>
</div>

<!-- USERS -->
<div class="modal-bg" id="modal-user">
  <div class="modal-sheet">
    <div class="mhandle"></div>
    <div class="mtitle">ğŸ‘¥ Gerenciar UsuÃ¡rios</div>
    <div id="user-list-admin" style="margin-bottom:18px"></div>
    <div class="section-divider">Cadastrar novo usuÃ¡rio</div>
    <div class="fg"><label>Nome Completo</label><input type="text" id="nu-nome" placeholder="Nome completo"></div>
    <div class="fg"><label>E-mail</label><input type="email" id="nu-email" placeholder="email@frutesp.com"></div>
    <div class="fg"><label>Senha</label><input type="password" id="nu-senha" placeholder="Senha segura"></div>
    <div class="frow">
      <div class="fg"><label>Perfil</label>
        <select id="nu-perfil">
          <option>Gestor</option><option>Atendente</option><option>Solicitante</option>
        </select></div>
      <div class="fg"><label>Setor</label>
        <select id="nu-setor">
          <option>GestÃ£o</option><option>ProduÃ§Ã£o</option><option>MecÃ¢nica</option>
          <option>IrrigaÃ§Ã£o</option><option>Packing House</option><option>Administrativo</option>
        </select></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-g" style="flex:1" onclick="closeModal('modal-user')">Fechar</button>
      <button class="btn btn-p" style="flex:2" onclick="submitUser()">Cadastrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â• PDF REPORT â•â•â•â•â•â•â•â• -->
<div id="pdf-report" class="no-print">
  <!-- Preenchido dinamicamente antes do print -->
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SLA_H = { baixa:72, media:48, alta:24, critica:6 };
const EQ_ICONS = { Trator:'ğŸšœ', Pulverizador:'ğŸŒ¿', Bomba:'ğŸ’§', Esteira:'âš™ï¸',
  Compressor:'ğŸ”©', VeÃ­culo:'ğŸš—', Outro:'ğŸ”§' };
const DR_ST_LBL = { disponivel:'DisponÃ­vel', em_voo:'Em Voo', manutencao:'ManutenÃ§Ã£o', inativo:'Inativo' };
const DR_ST_CLS = { disponivel:'es-a', em_voo:'es-m', manutencao:'es-m', inativo:'es-i' };
const MS_LBL = { planned:'Planejado', active:'Em ExecuÃ§Ã£o', done:'ConcluÃ­do' };
const MS_ICO = { PulverizaÃ§Ã£o:'ğŸ’§', Monitoramento:'ğŸ‘', Mapeamento:'ğŸ—º', IrrigaÃ§Ã£o:'ğŸš¿', Outro:'âœˆï¸' };

let users = [
  { id:1, email:'maykons@frutesp.com', senha:'#Mds2026',
    nome:'Maykons', perfil:'Gestor', setor:'GestÃ£o', avatar:'MF' }
];
let tickets = [];
let equipamentos = [];
let drones = [];
let sectorChats = {};
let currentUser = null;
let currentTicketId = null;
let currentDroneId = null;
let currentSector = null;
let currentFilter = 'todos';
let tkCounter = 1000;
let eqCounter = 0;
let drCounter = 0;

const SETORES = ['ProduÃ§Ã£o','MecÃ¢nica','IrrigaÃ§Ã£o','Packing House','Administrativo','GestÃ£o'];
SETORES.forEach(s => { sectorChats[s] = []; });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function doLogin() {
  const email = document.getElementById('inp-email').value.trim().toLowerCase();
  const senha = document.getElementById('inp-senha').value;
  const user = users.find(u => u.email.toLowerCase() === email && u.senha === senha);
  if (!user) { document.getElementById('login-err').style.display='block'; return; }
  document.getElementById('login-err').style.display='none';
  currentUser = user;
  document.getElementById('screen-login').classList.remove('active');
  document.getElementById('screen-app').classList.add('active');
  initApp();
}
function doLogout() {
  currentUser = null;
  document.getElementById('screen-app').classList.remove('active');
  document.getElementById('screen-login').classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp() {
  document.getElementById('tb-avatar').textContent = currentUser.avatar;
  document.getElementById('tb-setor').textContent = currentUser.setor;
  document.getElementById('pf-avatar').textContent = currentUser.avatar;
  document.getElementById('pf-name').textContent = currentUser.nome;
  document.getElementById('pf-role').textContent = currentUser.perfil;
  document.getElementById('pf-email').textContent = currentUser.email;
  const isGestor = currentUser.perfil === 'Gestor';
  document.getElementById('btn-relatorio').style.display = isGestor ? '' : 'none';
  document.getElementById('aging-section').style.display = isGestor ? '' : 'none';
  refreshEquipSelect();
  renderDash();
  renderTickets('todos');
  renderEquip();
  renderDrones();
  initChat();
  renderUserAdmin();
  updateBadge();
  navTo('dashboard');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function navTo(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pg = document.getElementById('page-'+page);
  if (pg) pg.classList.add('active');
  const pages = ['dashboard','tickets','chat','drones','equip','perfil'];
  const idx = pages.indexOf(page);
  const navItems = document.querySelectorAll('.nav-item');
  if (idx >= 0 && navItems[idx]) navItems[idx].classList.add('active');
  document.getElementById('fab').style.display =
    (page==='tickets'||page==='dashboard') ? 'flex' : 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AGING HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getDias(ts) {
  return Math.floor((Date.now() - ts) / 86400000);
}
function agingLevel(dias) {
  if (dias <= 1) return 0;
  if (dias <= 3) return 1;
  if (dias <= 7) return 2;
  if (dias <= 14) return 3;
  return 4;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getVisible() {
  if (currentUser.perfil==='Gestor') return tickets;
  if (currentUser.perfil==='Atendente') return tickets.filter(t => t.setor===currentUser.setor);
  return tickets.filter(t => t.criadoPor===currentUser.id);
}
function isSLAVencido(t) {
  return Date.now() > t.slaDeadline && t.status!=='DONE' && t.status!=='CANCELED';
}

function renderDash() {
  const all = getVisible();
  const open = all.filter(t => t.status!=='DONE' && t.status!=='CANCELED');
  const crit = all.filter(t => t.prioridade==='critica' && t.status!=='DONE' && t.status!=='CANCELED');
  const slaVen = all.filter(t => isSLAVencido(t));
  const done = all.filter(t => t.status==='DONE');
  const paredaTotal = all.reduce((s,t) => s+(t.parada||0), 0);
  const slaOk = done.filter(t => !isSLAVencido(t)).length;
  const slaPct = done.length ? Math.round(slaOk/done.length*100) : 100;

  document.getElementById('dash-title').textContent =
    currentUser.perfil==='Gestor' ? 'Dashboard Geral' : `Dashboard â€“ ${currentUser.setor}`;

  document.getElementById('stats-grid').innerHTML = `
    <div class="sc sc-g"><div class="si">ğŸ“‹</div>
      <div class="sv">${open.length}</div><div class="sl">Em Aberto</div></div>
    <div class="sc sc-r"><div class="si">ğŸš¨</div>
      <div class="sv">${crit.length}</div><div class="sl">CrÃ­ticos</div></div>
    <div class="sc sc-o"><div class="si">âš ï¸</div>
      <div class="sv">${slaVen.length}</div><div class="sl">SLA Vencido</div></div>
    <div class="sc sc-b"><div class="si">âœ…</div>
      <div class="sv">${slaPct}%</div><div class="sl">SLA Cumprido</div></div>
    <div class="sc sc-y"><div class="si">â±</div>
      <div class="sv">${paredaTotal}</div><div class="sl">Min. Parado</div></div>
    <div class="sc sc-g"><div class="si">ğŸš</div>
      <div class="sv">${drones.length}</div><div class="sl">Drones</div></div>`;

  /* AGING PANEL */
  if (currentUser.perfil === 'Gestor') {
    const agingOpen = open.sort((a,b) => a.criadoEm - b.criadoEm);
    if (!agingOpen.length) {
      document.getElementById('aging-list').innerHTML =
        `<div style="padding:20px 16px;text-align:center;color:var(--text3);font-size:13px">
          ğŸ‰ Nenhum chamado em aberto!
        </div>`;
    } else {
      document.getElementById('aging-list').innerHTML = agingOpen.map(t => {
        const dias = getDias(t.criadoEm);
        const lv = agingLevel(dias);
        return `<div class="aging-row" onclick="openDetail(${t.id})">
          <div class="age-indicator age-${lv}"></div>
          <div class="age-info">
            <div class="age-title">${t.proto} â€“ ${t.titulo}</div>
            <div class="age-sub">
              <span class="badge bp-${t.prioridade}" style="font-size:10px;padding:2px 6px">${t.prioridade}</span>
              &nbsp;${t.setor}${t.equip ? ' Â· '+t.equip.split('â€“')[0].trim() : ''}
            </div>
          </div>
          <div class="age-days">
            <div class="age-days-val agetext-${lv}">${dias}</div>
            <div class="age-days-lbl">${dias===1?'dia':'dias'}</div>
          </div>
        </div>`;
      }).join('');
    }
  }

  /* CHARTS */
  const setores = ['ProduÃ§Ã£o','MecÃ¢nica','IrrigaÃ§Ã£o','Packing House','Administrativo'];
  const maxS = Math.max(...setores.map(s => all.filter(t => t.setor===s).length), 1);
  document.getElementById('bar-setor').innerHTML = setores.map(s => {
    const c = all.filter(t => t.setor===s).length;
    return `<div class="br"><div class="bl">${s.replace(' House','')}</div>
      <div class="bt"><div class="bf" style="width:${c/maxS*100}%"></div></div>
      <div class="bv">${c}</div></div>`;
  }).join('');

  const eMap = {};
  all.forEach(t => { if(t.equipProb) eMap[t.equipProb]=(eMap[t.equipProb]||0)+1; });
  const eArr = Object.entries(eMap).sort((a,b) => b[1]-a[1]).slice(0,5);
  const maxE = eArr.length ? eArr[0][1] : 1;
  document.getElementById('bar-equip').innerHTML = eArr.length ? eArr.map(([k,v]) => {
    const lbl = k.split('â€“')[0].trim();
    return `<div class="br"><div class="bl">${lbl}</div>
      <div class="bt"><div class="bf" style="width:${v/maxE*100}%;background:linear-gradient(90deg,var(--g500),var(--orange))"></div></div>
      <div class="bv">${v}</div></div>`;
  }).join('') : `<p style="color:var(--text4);font-size:13px;padding:8px 0">Sem ocorrÃªncias ainda.</p>`;

  const prioList = ['critica','alta','media','baixa'];
  const maxP = Math.max(...prioList.map(p => all.filter(t => t.prioridade===p).length), 1);
  const prioColors = { critica:'var(--red)', alta:'var(--orange)', media:'var(--yellow)', baixa:'var(--blue)' };
  document.getElementById('bar-prio').innerHTML = prioList.map(p => {
    const c = all.filter(t => t.prioridade===p).length;
    return `<div class="br"><div class="bl">${p.charAt(0).toUpperCase()+p.slice(1)}</div>
      <div class="bt"><div class="bf" style="width:${c/maxP*100}%;background:${prioColors[p]}"></div></div>
      <div class="bv">${c}</div></div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function filterTk(f, el) {
  currentFilter = f;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderTickets(f);
}

function renderTickets(filter) {
  let list = getVisible();
  if (filter==='sla') list = list.filter(t => isSLAVencido(t));
  else if (filter!=='todos') list = list.filter(t => t.status===filter);
  const pri = {critica:0,alta:1,media:2,baixa:3};
  list = list.sort((a,b) => (pri[a.prioridade]||2)-(pri[b.prioridade]||2) || b.criadoEm-a.criadoEm);
  document.getElementById('tc-count').textContent = list.length;
  if (!list.length) {
    document.getElementById('ticket-list').innerHTML =
      `<div class="empty"><div class="empty-icon">ğŸ“­</div><p>Nenhum chamado encontrado.</p></div>`;
    return;
  }
  document.getElementById('ticket-list').innerHTML = list.map(t => {
    const v = isSLAVencido(t);
    const tot = t.slaDeadline - t.criadoEm;
    const pct = Math.min(100, Math.round((Date.now()-t.criadoEm)/tot*100));
    const fc = v ? 'var(--red)' : pct>70 ? 'var(--orange)' : 'var(--g400)';
    const dias = getDias(t.criadoEm);
    const lv = agingLevel(dias);
    const tipoBadge = t.tipoProb==='maquina' ? 'ğŸ”§' : t.tipoProb==='material' ? 'ğŸ“¦' :
      t.tipoProb==='ambos' ? 'ğŸ”§ğŸ“¦' : '';
    return `<div class="tk-card tc-${t.prioridade} ${v?'tc-vencido':''}" onclick="openDetail(${t.id})">
      <div class="tk-top">
        <span class="tk-proto">${t.proto}</span>
        <div style="display:flex;gap:5px;align-items:center">
          ${v?'<span class="badge b-sla">âš ï¸ SLA</span>':''}
          <span class="badge agetext-${lv}" style="background:rgba(0,0,0,.2);font-size:10px">
            ${dias}d
          </span>
        </div>
      </div>
      <div class="tk-title">${t.titulo}</div>
      <div class="tk-meta">
        <span class="badge bs-${t.status}">${stLabel(t.status)}</span>
        <span class="badge bp-${t.prioridade}">${t.prioridade}</span>
        <span class="badge b-setor">${t.setor}</span>
        ${tipoBadge ? `<span class="badge b-cat">${tipoBadge}</span>` : ''}
      </div>
      <div class="sla-bar"><div class="sla-fill" style="width:${pct}%;background:${fc}"></div></div>
    </div>`;
  }).join('');
}

function stLabel(s) {
  return {OPEN:'Aberto',IN_PROGRESS:'Em Andamento',WAITING:'Aguardando',DONE:'ConcluÃ­do',CANCELED:'Cancelado'}[s]||s;
}
function updateBadge() {
  const c = getVisible().filter(t => t.status==='OPEN').length;
  const b = document.getElementById('nav-badge');
  b.textContent = c; b.style.display = c>0 ? 'flex' : 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW TICKET FORM â€” SEÃ‡Ã•ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleProblemSections() {
  const val = document.getElementById('nt-tipo-prob').value;
  const secMaq = document.getElementById('sec-maquina');
  const secMat = document.getElementById('sec-materiais');
  secMaq.style.display = (val==='maquina'||val==='ambos') ? '' : 'none';
  secMat.style.display = (val==='material'||val==='ambos') ? '' : 'none';
}

function addMatRow() {
  const row = document.createElement('div');
  row.className = 'mat-row frow';
  row.style.marginBottom = '8px';
  row.innerHTML = `
    <div class="fg" style="margin-bottom:0"><label>Item / Produto</label>
      <input type="text" class="mat-nome" placeholder="Ex: Herbicida, Adubo..."></div>
    <div class="fg" style="margin-bottom:0"><label>Qtd / Unid.</label>
      <input type="text" class="mat-qtd" placeholder="Ex: 5 L, 2 kg"></div>`;
  document.getElementById('mat-rows').appendChild(row);
}

function collectMateriais() {
  const rows = document.querySelectorAll('.mat-row');
  const items = [];
  rows.forEach(r => {
    const nome = r.querySelector('.mat-nome').value.trim();
    const qtd = r.querySelector('.mat-qtd').value.trim();
    if (nome) items.push({ nome, qtd });
  });
  return items;
}

function makeTicket(d) {
  tkCounter++;
  return {
    id: tkCounter, proto: `#FRU-${tkCounter}`,
    titulo: d.titulo, descricao: d.descricao, categoria: d.categoria,
    prioridade: d.prioridade, setor: d.setor, local: d.local,
    impacto: d.impacto, parada: d.parada,
    tipoProb: d.tipoProb,
    equipProb: d.equipProb, falha: d.falha, componentes: d.componentes,
    materiais: d.materiais,
    criadoPor: d.criadoPor, criadoEm: Date.now(), responsavel: null, status: 'OPEN',
    slaDeadline: Date.now() + (SLA_H[d.prioridade]||48)*3600000,
    chat: [], history: [{ acao:'Chamado aberto', usuario:d.criadoPor, ts:Date.now(), de:null, para:'OPEN' }]
  };
}

function submitTicket() {
  const titulo = document.getElementById('nt-titulo').value.trim();
  if (!titulo) { showToast('Informe o tÃ­tulo!'); return; }
  const tipoProb = document.getElementById('nt-tipo-prob').value;
  const t = makeTicket({
    titulo,
    descricao: document.getElementById('nt-desc').value.trim(),
    categoria: document.getElementById('nt-cat').value,
    prioridade: document.getElementById('nt-pri').value,
    setor: document.getElementById('nt-setor').value,
    local: document.getElementById('nt-local').value,
    impacto: document.getElementById('nt-impacto').value,
    parada: parseInt(document.getElementById('nt-parada').value)||0,
    tipoProb,
    equipProb: (tipoProb==='maquina'||tipoProb==='ambos') ? document.getElementById('nt-equip-prob').value : '',
    falha: (tipoProb==='maquina'||tipoProb==='ambos') ? document.getElementById('nt-falha').value.trim() : '',
    componentes: (tipoProb==='maquina'||tipoProb==='ambos') ? document.getElementById('nt-componentes').value.trim() : '',
    materiais: (tipoProb==='material'||tipoProb==='ambos') ? collectMateriais() : [],
    criadoPor: currentUser.id
  });
  tickets.unshift(t);
  closeModal('modal-ticket');
  document.getElementById('nt-titulo').value='';
  document.getElementById('nt-desc').value='';
  document.getElementById('nt-falha').value='';
  document.getElementById('nt-componentes').value='';
  // reset mat rows
  document.getElementById('mat-rows').innerHTML = `
    <div class="mat-row frow" style="margin-bottom:8px">
      <div class="fg" style="margin-bottom:0"><label>Item / Produto</label>
        <input type="text" class="mat-nome" placeholder="Ex: Herbicida, Adubo..."></div>
      <div class="fg" style="margin-bottom:0"><label>Qtd / Unid.</label>
        <input type="text" class="mat-qtd" placeholder="Ex: 5 L, 2 kg"></div>
    </div>`;
  showToast(`âœ… Chamado ${t.proto} aberto!`);
  renderTickets('todos'); renderDash(); updateBadge();
  navTo('tickets');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKET DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDetail(id) {
  const t = tickets.find(x => x.id===id); if (!t) return;
  currentTicketId = id;
  document.getElementById('dh-proto').textContent = t.proto;
  document.getElementById('dh-badge').innerHTML = `<span class="badge bs-${t.status}">${stLabel(t.status)}</span>`;
  document.getElementById('d-titulo').textContent = t.titulo;
  document.getElementById('d-cat').textContent = t.categoria;
  document.getElementById('d-tipo-prob').textContent = {
    maquina:'ğŸ”§ MÃ¡quina / Equipamento',
    material:'ğŸ“¦ Material / Produto',
    ambos:'ğŸ”§ğŸ“¦ MÃ¡quina + Materiais',
    outro:'ğŸ“‹ Outro'
  }[t.tipoProb] || 'â€“';
  document.getElementById('d-pri').innerHTML = `<span class="badge bp-${t.prioridade}">${t.prioridade}</span>`;
  document.getElementById('d-setor').textContent = t.setor;
  document.getElementById('d-local').textContent = t.local;
  document.getElementById('d-impacto').textContent = t.impacto;
  document.getElementById('d-parada').textContent = t.parada+' min';
  document.getElementById('d-desc').textContent = t.descricao || 'Sem descriÃ§Ã£o.';

  // MÃQUINA
  const secMaq = document.getElementById('d-sec-maquina');
  if (t.tipoProb==='maquina'||t.tipoProb==='ambos') {
    secMaq.style.display = '';
    document.getElementById('d-equip-prob').textContent = t.equipProb || 'â€“';
    document.getElementById('d-falha').textContent = t.falha || 'â€“';
    const compArea = document.getElementById('d-comp-area');
    if (t.componentes) {
      compArea.innerHTML = `<div class="dr" style="flex-direction:column;align-items:flex-start;gap:6px">
        <span class="drl">PeÃ§as / Componentes</span>
        <span style="color:var(--text1);font-size:13.5px">${t.componentes}</span>
      </div>`;
    } else { compArea.innerHTML=''; }
  } else { secMaq.style.display='none'; }

  // MATERIAIS
  const secMat = document.getElementById('d-sec-materiais');
  if ((t.tipoProb==='material'||t.tipoProb==='ambos') && t.materiais && t.materiais.length) {
    secMat.style.display = '';
    document.getElementById('d-mat-list').innerHTML = t.materiais.map(m =>
      `<div class="dr"><span class="drl">${m.nome}</span><span class="drv">${m.qtd||'â€“'}</span></div>`
    ).join('');
  } else { secMat.style.display='none'; }

  const dias = getDias(t.criadoEm);
  const lv = agingLevel(dias);
  document.getElementById('d-abertura').textContent = fmtDate(t.criadoEm);
  document.getElementById('d-dias').innerHTML =
    `<span class="agetext-${lv}" style="font-weight:700">${dias} ${dias===1?'dia':'dias'}</span>`;
  document.getElementById('d-sla').innerHTML =
    `${fmtDate(t.slaDeadline)} ${isSLAVencido(t)?'<span class="badge b-sla" style="margin-left:4px">Vencido</span>':''}`;
  const resp = users.find(u => u.id===t.responsavel);
  document.getElementById('d-resp').textContent = resp ? resp.nome : 'NÃ£o atribuÃ­do';
  const sol = users.find(u => u.id===t.criadoPor);
  document.getElementById('d-sol').textContent = sol ? sol.nome : 'â€“';

  renderTkChat(t); renderTkHistory(t); renderTkActions(t);
  const ov = document.getElementById('detail-overlay');
  ov.classList.add('open'); ov.scrollTop = 0;
}

function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('open');
  currentTicketId = null;
}

function renderTkChat(t) {
  const el = document.getElementById('ticket-msgs');
  el.innerHTML = t.chat.length ? t.chat.map(m => {
    const mine = m.userId===currentUser.id;
    return `<div class="cmsg ${mine?'mine':'other'}">
      <div class="cbub">${m.msg}</div>
      <div class="cmeta">${m.userName} Â· ${fmtTime(m.ts)}</div>
    </div>`;
  }).join('') : `<p style="color:var(--text4);font-size:13px;text-align:center;padding:16px">Sem mensagens.</p>`;
  el.scrollTop = el.scrollHeight;
}

function sendTicketMsg() {
  const inp = document.getElementById('ticket-chat-inp');
  const msg = inp.value.trim(); if (!msg||!currentTicketId) return;
  const t = tickets.find(x => x.id===currentTicketId);
  t.chat.push({ userId:currentUser.id, userName:currentUser.nome, msg, ts:Date.now() });
  inp.value = ''; renderTkChat(t);
}

function renderTkHistory(t) {
  document.getElementById('tk-history').innerHTML =
    t.history.slice().reverse().map(h => {
      const u = users.find(x => x.id===h.usuario);
      return `<div class="log-item"><div class="log-dot"></div>
        <div style="flex:1">
          <div class="log-act">${h.acao}</div>
          ${h.de ? `<div class="log-det">${h.de} â†’ ${h.para}</div>` : ''}
          <div class="log-t">${u?u.nome:'â€“'} Â· ${fmtDate(h.ts)}</div>
        </div></div>`;
    }).join('');
}

function renderTkActions(t) {
  const bar = document.getElementById('tk-actions');
  if (t.status==='DONE'||t.status==='CANCELED') {
    bar.innerHTML=`<p style="color:var(--text3);font-size:13px;text-align:center;width:100%">Chamado encerrado</p>`;
    return;
  }
  const p = currentUser.perfil;
  let html = '';
  if (p==='Atendente') {
    if (t.status==='OPEN') html=`<button class="btn btn-g" style="flex:1" onclick="chgStatus('IN_PROGRESS')">â–¶ Assumir</button>`;
    if (t.status==='IN_PROGRESS') html=`
      <button class="btn btn-g" style="flex:1" onclick="chgStatus('WAITING')">â¸ Aguardar</button>
      <button class="btn btn-p" style="flex:1" onclick="chgStatus('DONE')">âœ… Concluir</button>`;
    if (t.status==='WAITING') html=`<button class="btn btn-p" style="flex:1" onclick="chgStatus('IN_PROGRESS')">â–¶ Retomar</button>`;
  }
  if (p==='Gestor') html=`
    <select id="sel-st" style="padding:11px;border-radius:var(--RS);border:1.5px solid var(--border-md);
      background:var(--surface-card);color:var(--text1);font-family:var(--fb);flex:1">
      <option value="OPEN" ${t.status==='OPEN'?'selected':''}>Aberto</option>
      <option value="IN_PROGRESS" ${t.status==='IN_PROGRESS'?'selected':''}>Em Andamento</option>
      <option value="WAITING" ${t.status==='WAITING'?'selected':''}>Aguardando</option>
      <option value="DONE" ${t.status==='DONE'?'selected':''}>ConcluÃ­do</option>
      <option value="CANCELED">Cancelar</option>
    </select>
    <button class="btn btn-p" style="flex:1" onclick="chgStatus(document.getElementById('sel-st').value)">Aplicar</button>`;
  bar.innerHTML = html;
}

function chgStatus(ns) {
  const t = tickets.find(x => x.id===currentTicketId);
  const old = t.status; t.status = ns;
  t.history.push({ acao:'Status alterado', de:stLabel(old), para:stLabel(ns), usuario:currentUser.id, ts:Date.now() });
  showToast(`Status: ${stLabel(ns)}`);
  openDetail(currentTicketId); renderTickets(currentFilter); renderDash(); updateBadge();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTOR CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initChat() {
  let setores = SETORES;
  if (currentUser.perfil !== 'Gestor') setores = [currentUser.setor];
  const tabs = document.getElementById('sector-tabs');
  tabs.innerHTML = setores.map((s,i) =>
    `<div class="stab ${i===0?'active':''}" onclick="swSector('${s}',this)">${s}</div>`
  ).join('');
  currentSector = setores[0]; renderSectorChat();
}
function swSector(s, el) {
  currentSector = s;
  document.querySelectorAll('.stab').forEach(t => t.classList.remove('active'));
  el.classList.add('active'); renderSectorChat();
}
function renderSectorChat() {
  if (!sectorChats[currentSector]) sectorChats[currentSector]=[];
  const msgs = sectorChats[currentSector];
  const el = document.getElementById('sector-msgs');
  el.innerHTML = msgs.length ? msgs.map(m => {
    const mine = m.user.id===currentUser.id;
    return `<div class="cmsg ${mine?'mine':'other'}">
      <div class="cbub">${m.msg}</div>
      <div class="cmeta">${m.user.nome} Â· ${fmtTime(m.ts)}</div>
    </div>`;
  }).join('') : `<p style="color:var(--text4);font-size:13px;text-align:center;padding:24px">Sem mensagens ainda.</p>`;
  el.scrollTop = el.scrollHeight;
}
function sendSectorMsg() {
  const inp = document.getElementById('sector-input');
  const msg = inp.value.trim(); if (!msg) return;
  if (!sectorChats[currentSector]) sectorChats[currentSector]=[];
  sectorChats[currentSector].push({ user:currentUser, msg, ts:Date.now() });
  inp.value=''; renderSectorChat();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EQUIPAMENTOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderEquip() {
  const list = currentUser.perfil==='Gestor' ? equipamentos :
    equipamentos.filter(e => e.setor===currentUser.setor);
  document.getElementById('equip-list').innerHTML = list.length ? list.map(e => {
    const ic = EQ_ICONS[e.tipo]||'ğŸ”§';
    const rels = tickets.filter(t => t.equipProb && t.equipProb.includes(e.codigo)).length;
    return `<div class="eq-card" onclick="showEquipInfo(${e.id})">
      <div class="eq-icon">${ic}</div>
      <div style="flex:1">
        <div class="eq-name">${e.nome}</div>
        <div class="eq-sub">${e.codigo} Â· ${e.tipo} Â· ${e.setor}</div>
        ${e.horimetro ? `<div class="eq-sub">â± ${e.horimetro}h Â· ${rels} chamado(s)</div>` : `<div class="eq-sub">${rels} chamado(s)</div>`}
      </div>
      <div class="es es-${e.status==='ativo'?'a':e.status==='manutencao'?'m':'i'}">${e.status==='manutencao'?'ManutenÃ§Ã£o':e.status.charAt(0).toUpperCase()+e.status.slice(1)}</div>
    </div>`;
  }).join('') : `<div class="empty"><div class="empty-icon">ğŸ”§</div><p>Nenhum equipamento cadastrado.<br>Clique em "+ Novo" para adicionar.</p></div>`;
}

function showEquipInfo(id) {
  const e = equipamentos.find(x => x.id===id);
  showToast(`${e.nome} â€” PrÃ³x. Preventiva: ${e.proximaPreventiva||'nÃ£o definida'}`);
}

function submitEquip() {
  const nome = document.getElementById('eq-nome').value.trim();
  if (!nome) { showToast('Informe o nome!'); return; }
  eqCounter++;
  equipamentos.push({
    id:eqCounter, nome,
    codigo: document.getElementById('eq-cod').value.trim() || `EQ-${String(eqCounter).padStart(3,'0')}`,
    tipo: document.getElementById('eq-tipo').value,
    setor: document.getElementById('eq-setor').value,
    local: document.getElementById('eq-local').value,
    horimetro: parseFloat(document.getElementById('eq-hor').value)||null,
    status: document.getElementById('eq-status').value,
    ultimaPreventiva: document.getElementById('eq-ultp').value||null,
    proximaPreventiva: document.getElementById('eq-proxp').value||null,
  });
  closeModal('modal-equip');
  document.getElementById('eq-nome').value='';
  document.getElementById('eq-cod').value='';
  showToast('âœ… Equipamento cadastrado!');
  renderEquip(); refreshEquipSelect(); renderDash();
}

function refreshEquipSelect() {
  const sel = document.getElementById('nt-equip-prob');
  sel.innerHTML = '<option value="">-- Selecione --</option>' +
    equipamentos.map(e => `<option value="${e.codigo} â€“ ${e.nome}">${e.codigo} â€“ ${e.nome}</option>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRONES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDrones() {
  const total = drones.length;
  const voos = drones.reduce((s,d) => s+(d.missions?d.missions.length:0), 0);
  const ha = drones.reduce((s,d) => s+(d.ha||0), 0);
  document.getElementById('ds-total').textContent = total;
  document.getElementById('ds-voos').textContent = voos;
  document.getElementById('ds-ha').textContent = ha;

  document.getElementById('drone-list').innerHTML = drones.length ? drones.map(d => {
    const mCnt = d.missions ? d.missions.length : 0;
    return `<div class="dr-card" onclick="openDroneDetail(${d.id})">
      <div class="drc-top">
        <div class="dr-avatar">ğŸš</div>
        <div style="flex:1">
          <div class="dr-name">${d.nome}</div>
          <div class="dr-code">${d.codigo} Â· ${d.modelo}</div>
        </div>
        <div class="es ${DR_ST_CLS[d.status]}">${DR_ST_LBL[d.status]}</div>
      </div>
      <div class="dr-meta">
        <div class="drm"><div class="drm-l">Horas de Voo</div><div class="drm-v">${d.horas}h</div></div>
        <div class="drm"><div class="drm-l">Ãrea Coberta</div><div class="drm-v">${d.ha} ha</div></div>
        <div class="drm"><div class="drm-l">Capacidade</div><div class="drm-v">${d.cap}L</div></div>
        <div class="drm"><div class="drm-l">MissÃµes</div><div class="drm-v">${mCnt}</div></div>
      </div>
    </div>`;
  }).join('') : `<div class="empty"><div class="empty-icon">ğŸš</div><p>Nenhum drone cadastrado.<br>Clique em "+ Novo" para adicionar.</p></div>`;
}

function submitDrone() {
  const nome = document.getElementById('dr-nome').value.trim();
  if (!nome) { showToast('Informe o nome!'); return; }
  drCounter++;
  drones.push({
    id:drCounter, nome,
    modelo: document.getElementById('dr-modelo').value.trim()||'NÃ£o informado',
    codigo: document.getElementById('dr-cod').value.trim()||`DR-${String(drCounter).padStart(3,'0')}`,
    setor: document.getElementById('dr-setor').value,
    cap: parseFloat(document.getElementById('dr-cap').value)||0,
    horas: parseFloat(document.getElementById('dr-horas').value)||0,
    ha: parseFloat(document.getElementById('dr-ha').value)||0,
    status: document.getElementById('dr-status').value,
    ultimaManutencao: document.getElementById('dr-mnt').value||null,
    proximaManutencao: document.getElementById('dr-proxmnt').value||null,
    missions: []
  });
  closeModal('modal-drone');
  document.getElementById('dr-nome').value='';
  document.getElementById('dr-modelo').value='';
  document.getElementById('dr-cod').value='';
  showToast('âœ… Drone cadastrado!');
  renderDrones(); renderDash();
}

function openDroneDetail(id) {
  const d = drones.find(x => x.id===id); if (!d) return;
  currentDroneId = id;
  document.getElementById('dro-name').textContent = d.nome;
  document.getElementById('dro-badge').innerHTML = `<div class="es ${DR_ST_CLS[d.status]}">${DR_ST_LBL[d.status]}</div>`;
  document.getElementById('dro-modelo').textContent = d.modelo;
  document.getElementById('dro-codigo').textContent = d.codigo;
  document.getElementById('dro-setor').textContent = d.setor;
  document.getElementById('dro-cap').textContent = d.cap+'L';
  document.getElementById('dro-horas').textContent = d.horas+'h';
  document.getElementById('dro-ha').textContent = d.ha+' ha';
  document.getElementById('dro-mnt').textContent = d.ultimaManutencao||'â€“';
  document.getElementById('dro-prox').textContent = d.proximaManutencao||'â€“';
  renderMissions(d);
  const ov = document.getElementById('drone-overlay');
  ov.classList.add('open'); ov.scrollTop=0;
}
function closeDroneDetail() {
  document.getElementById('drone-overlay').classList.remove('open');
  currentDroneId = null;
}
function renderMissions(d) {
  document.getElementById('dro-missions').innerHTML = (d.missions&&d.missions.length) ?
    d.missions.map(m => `<div class="ms-card">
      <div class="ms-ico">${MS_ICO[m.tipo]||'âœˆï¸'}</div>
      <div class="ms-info">
        <div class="ms-ttl">${m.titulo}</div>
        <div class="ms-sub">${m.tipo} Â· ${m.ha}ha Â· ${m.data||'â€“'} Â· ${m.duracao}min</div>
        ${m.obs ? `<div class="ms-sub" style="margin-top:2px;font-style:italic">${m.obs}</div>` : ''}
      </div>
      <div class="ms-st ${m.status==='planned'?'ms-planned':m.status==='active'?'ms-active':'ms-done'}">${MS_LBL[m.status]}</div>
    </div>`).join('') :
    `<p style="color:var(--text4);font-size:13px;padding:12px 0">Nenhuma missÃ£o registrada.</p>`;
}
function openMissionModal() {
  document.getElementById('ms-data').value = new Date().toISOString().slice(0,10);
  openModal('modal-mission');
}
function submitMission() {
  const titulo = document.getElementById('ms-titulo').value.trim();
  if (!titulo) { showToast('Informe o tÃ­tulo!'); return; }
  const d = drones.find(x => x.id===currentDroneId); if (!d) return;
  const ha = parseFloat(document.getElementById('ms-ha').value)||0;
  const dur = parseInt(document.getElementById('ms-dur').value)||0;
  d.missions.push({
    titulo, tipo:document.getElementById('ms-tipo').value,
    ha, data:document.getElementById('ms-data').value,
    duracao:dur, status:document.getElementById('ms-status').value,
    obs:document.getElementById('ms-obs').value.trim()
  });
  d.ha += ha;
  d.horas = Math.round((d.horas + dur/60)*10)/10;
  closeModal('modal-mission');
  document.getElementById('ms-titulo').value='';
  document.getElementById('ms-obs').value='';
  showToast('âœ… MissÃ£o registrada!');
  renderMissions(d); renderDrones();
}
function deleteDrone() {
  if (!currentDroneId) return;
  if (!confirm('Excluir este drone?')) return;
  drones = drones.filter(x => x.id!==currentDroneId);
  closeDroneDetail(); renderDrones(); renderDash();
  showToast('Drone removido.');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderUserAdmin() {
  document.getElementById('user-list-admin').innerHTML = users.map(u =>
    `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="width:36px;height:36px;background:var(--g600);border-radius:50%;
        display:flex;align-items:center;justify-content:center;font-weight:700;
        font-size:13px;color:var(--text1)">${u.avatar}</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:600;color:var(--text1)">${u.nome}</div>
        <div style="font-size:12px;color:var(--text3)">${u.perfil} Â· ${u.setor} Â· ${u.email}</div>
      </div>
      ${u.id!==currentUser.id ?
        `<button class="btn btn-xs btn-d" onclick="removeUser(${u.id})">Remover</button>` :
        `<span style="font-size:11px;color:var(--g300)">VocÃª</span>`}
    </div>`
  ).join('');
}
function submitUser() {
  const nome = document.getElementById('nu-nome').value.trim();
  const email = document.getElementById('nu-email').value.trim();
  const senha = document.getElementById('nu-senha').value;
  if (!nome||!email||!senha) { showToast('Preencha todos os campos!'); return; }
  if (users.find(u => u.email.toLowerCase()===email.toLowerCase())) { showToast('E-mail jÃ¡ cadastrado!'); return; }
  const initials = nome.split(' ').map(p=>p[0].toUpperCase()).slice(0,2).join('');
  users.push({ id:Date.now(), email, senha, nome,
    perfil:document.getElementById('nu-perfil').value,
    setor:document.getElementById('nu-setor').value,
    avatar:initials||nome[0].toUpperCase() });
  document.getElementById('nu-nome').value='';
  document.getElementById('nu-email').value='';
  document.getElementById('nu-senha').value='';
  showToast('âœ… UsuÃ¡rio cadastrado!'); renderUserAdmin();
}
function removeUser(id) {
  if (!confirm('Remover este usuÃ¡rio?')) return;
  users = users.filter(u => u.id!==id); renderUserAdmin(); showToast('UsuÃ¡rio removido.');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SLA CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSLAConfig() {
  showToast(`SLA: Baixa ${SLA_H.baixa}h | MÃ©dia ${SLA_H.media}h | Alta ${SLA_H.alta}h | CrÃ­tica ${SLA_H.critica}h`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gerarRelatorio() {
  const all = getVisible();
  const now = new Date();
  const open = all.filter(t => t.status!=='DONE'&&t.status!=='CANCELED');
  const done = all.filter(t => t.status==='DONE');
  const crit = all.filter(t => t.prioridade==='critica');
  const slaVen = all.filter(t => isSLAVencido(t));
  const paredaTotal = all.reduce((s,t)=>s+(t.parada||0),0);
  const slaOk = done.filter(t=>!isSLAVencido(t)).length;
  const slaPct = done.length ? Math.round(slaOk/done.length*100) : 100;

  const setores = ['ProduÃ§Ã£o','MecÃ¢nica','IrrigaÃ§Ã£o','Packing House','Administrativo'];
  const prios = ['critica','alta','media','baixa'];

  // Aging counts
  const agingBuckets = [0,0,0,0,0];
  open.forEach(t => { agingBuckets[agingLevel(getDias(t.criadoEm))]++; });

  const reportHTML = `
    <style>
      body{font-family:Arial,sans-serif;color:#1a1a1a;font-size:12px;background:white}
      .pdf-page{padding:28px 32px;max-width:800px;margin:0 auto}
      .pdf-header{display:flex;align-items:center;justify-content:space-between;
        border-bottom:3px solid #0B3D2E;padding-bottom:16px;margin-bottom:24px}
      .pdf-logo{font-size:22px;font-weight:900;color:#0B3D2E;font-family:Arial,sans-serif}
      .pdf-logo span{color:#2EB87F}
      .pdf-date{font-size:11px;color:#666;text-align:right}
      .pdf-title{font-size:18px;font-weight:700;color:#0B3D2E;margin-bottom:4px}
      .pdf-sub{font-size:11px;color:#888;margin-bottom:24px}
      .stats-row{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
      .stat-box{flex:1;min-width:100px;background:#f0f9f4;border-left:4px solid #0B3D2E;
        padding:12px 14px;border-radius:6px}
      .stat-box.red{background:#fff0f0;border-left-color:#c0392b}
      .stat-box.orange{background:#fff8f0;border-left-color:#e67e22}
      .stat-box.blue{background:#f0f6ff;border-left-color:#2980b9}
      .stat-box.gray{background:#f5f5f5;border-left-color:#95a5a6}
      .stat-v{font-size:26px;font-weight:800;color:#0B3D2E;line-height:1}
      .stat-box.red .stat-v{color:#c0392b}
      .stat-box.orange .stat-v{color:#e67e22}
      .stat-box.blue .stat-v{color:#2980b9}
      .stat-l{font-size:10px;color:#666;margin-top:3px}
      .sec-title{font-size:13px;font-weight:700;color:#0B3D2E;
        border-bottom:2px solid #0B3D2E;padding-bottom:4px;margin-bottom:12px;margin-top:20px}
      table{width:100%;border-collapse:collapse;margin-bottom:16px;font-size:11px}
      th{background:#0B3D2E;color:white;padding:8px 10px;text-align:left;font-size:10.5px}
      td{padding:7px 10px;border-bottom:1px solid #eee;vertical-align:top}
      tr:nth-child(even) td{background:#f8f8f8}
      .pri-critica{color:#c0392b;font-weight:700}
      .pri-alta{color:#e67e22;font-weight:700}
      .pri-media{color:#d4ac47;font-weight:700}
      .pri-baixa{color:#2980b9;font-weight:700}
      .aging-row2{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #eee}
      .aging-bar2{flex:1;height:8px;background:#eee;border-radius:4px;overflow:hidden}
      .aging-fill2{height:100%;border-radius:4px}
      .footer{margin-top:28px;padding-top:12px;border-top:1px solid #ddd;
        font-size:10px;color:#aaa;display:flex;justify-content:space-between}
    </style>
    <div class="pdf-page">
      <div class="pdf-header">
        <div class="pdf-logo">FRUTE<span>SP</span></div>
        <div class="pdf-date">
          <div>RelatÃ³rio Gerencial</div>
          <div>Emitido em: ${now.toLocaleDateString('pt-BR')} Ã s ${now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</div>
          <div>Por: ${currentUser.nome}</div>
        </div>
      </div>

      <div class="pdf-title">RelatÃ³rio de GestÃ£o Operacional</div>
      <div class="pdf-sub">PerÃ­odo completo Â· ${all.length} chamado(s) registrado(s)</div>

      <div class="stats-row">
        <div class="stat-box"><div class="stat-v">${open.length}</div><div class="stat-l">Em Aberto</div></div>
        <div class="stat-box red"><div class="stat-v">${crit.length}</div><div class="stat-l">CrÃ­ticos</div></div>
        <div class="stat-box orange"><div class="stat-v">${slaVen.length}</div><div class="stat-l">SLA Vencido</div></div>
        <div class="stat-box blue"><div class="stat-v">${slaPct}%</div><div class="stat-l">SLA Cumprido</div></div>
        <div class="stat-box gray"><div class="stat-v">${paredaTotal}</div><div class="stat-l">Min. Parado</div></div>
        <div class="stat-box"><div class="stat-v">${done.length}</div><div class="stat-l">ConcluÃ­dos</div></div>
      </div>

      <div class="sec-title">Aging â€” Chamados em Aberto por Tempo</div>
      ${[
        { lbl:'0â€“1 dia', color:'#2EB87F', val:agingBuckets[0] },
        { lbl:'2â€“3 dias', color:'#55A9F0', val:agingBuckets[1] },
        { lbl:'4â€“7 dias', color:'#E0C050', val:agingBuckets[2] },
        { lbl:'8â€“14 dias', color:'#F09A55', val:agingBuckets[3] },
        { lbl:'15+ dias (CrÃ­tico)', color:'#F06565', val:agingBuckets[4] },
      ].map(b => {
        const pct = open.length ? Math.round(b.val/open.length*100) : 0;
        return `<div class="aging-row2">
          <div style="width:130px;font-size:11px;color:#444">${b.lbl}</div>
          <div class="aging-bar2"><div class="aging-fill2" style="width:${pct}%;background:${b.color}"></div></div>
          <div style="width:50px;text-align:right;font-size:11px;font-weight:700;color:${b.color}">${b.val}</div>
        </div>`;
      }).join('')}

      <div class="sec-title">DistribuiÃ§Ã£o por Setor</div>
      <table>
        <tr><th>Setor</th><th>Total</th><th>Abertos</th><th>ConcluÃ­dos</th><th>Min. Parado</th></tr>
        ${setores.map(s => {
          const st = all.filter(t=>t.setor===s);
          const so = st.filter(t=>t.status!=='DONE'&&t.status!=='CANCELED').length;
          const sd = st.filter(t=>t.status==='DONE').length;
          const sp = st.reduce((x,t)=>x+(t.parada||0),0);
          return `<tr><td>${s}</td><td>${st.length}</td><td>${so}</td><td>${sd}</td><td>${sp}</td></tr>`;
        }).join('')}
      </table>

      <div class="sec-title">DistribuiÃ§Ã£o por Prioridade</div>
      <table>
        <tr><th>Prioridade</th><th>Total</th><th>Abertos</th><th>ConcluÃ­dos</th></tr>
        ${prios.map(p => {
          const pt = all.filter(t=>t.prioridade===p);
          return `<tr><td class="pri-${p}">${p.charAt(0).toUpperCase()+p.slice(1)}</td>
            <td>${pt.length}</td>
            <td>${pt.filter(t=>t.status!=='DONE'&&t.status!=='CANCELED').length}</td>
            <td>${pt.filter(t=>t.status==='DONE').length}</td></tr>`;
        }).join('')}
      </table>

      ${open.length ? `
      <div class="sec-title">Chamados em Aberto (${open.length})</div>
      <table>
        <tr><th>Protocolo</th><th>TÃ­tulo</th><th>Setor</th><th>Prioridade</th><th>Status</th><th>Dias</th><th>SLA</th></tr>
        ${open.sort((a,b)=>agingLevel(getDias(b.criadoEm))-agingLevel(getDias(a.criadoEm))).map(t => {
          const dias = getDias(t.criadoEm);
          return `<tr>
            <td>${t.proto}</td>
            <td>${t.titulo}</td>
            <td>${t.setor}</td>
            <td class="pri-${t.prioridade}">${t.prioridade}</td>
            <td>${stLabel(t.status)}</td>
            <td style="font-weight:700;color:${agingLevel(dias)>=3?'#c0392b':agingLevel(dias)>=2?'#e67e22':'#2EB87F'}">${dias}d</td>
            <td style="color:${isSLAVencido(t)?'#c0392b':'#2EB87F'}">${isSLAVencido(t)?'Vencido':'OK'}</td>
          </tr>`;
        }).join('')}
      </table>` : ''}

      ${equipamentos.length ? `
      <div class="sec-title">Equipamentos</div>
      <table>
        <tr><th>CÃ³digo</th><th>Nome</th><th>Tipo</th><th>Setor</th><th>Status</th><th>Chamados</th><th>PrÃ³x. Prev.</th></tr>
        ${equipamentos.map(e => {
          const eRels = tickets.filter(t=>t.equipProb&&t.equipProb.includes(e.codigo)).length;
          return `<tr>
            <td>${e.codigo}</td><td>${e.nome}</td><td>${e.tipo}</td>
            <td>${e.setor}</td><td>${e.status}</td><td>${eRels}</td>
            <td>${e.proximaPreventiva||'â€“'}</td>
          </tr>`;
        }).join('')}
      </table>` : ''}

      ${drones.length ? `
      <div class="sec-title">Frota de Drones</div>
      <table>
        <tr><th>Nome</th><th>Modelo</th><th>Status</th><th>Horas</th><th>Ãrea (ha)</th><th>MissÃµes</th><th>PrÃ³x. Mnt.</th></tr>
        ${drones.map(d => `<tr>
          <td>${d.nome}</td><td>${d.modelo}</td><td>${DR_ST_LBL[d.status]}</td>
          <td>${d.horas}h</td><td>${d.ha}</td>
          <td>${d.missions?d.missions.length:0}</td>
          <td>${d.proximaManutencao||'â€“'}</td>
        </tr>`).join('')}
      </table>` : ''}

      <div class="footer">
        <span>FRUTESP GestÃ£o Operacional</span>
        <span>RelatÃ³rio gerado em ${now.toLocaleString('pt-BR')}</span>
      </div>
    </div>`;

  // Abre em nova aba para impressÃ£o/PDF
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>RelatÃ³rio FRUTESP</title></head><body>${reportHTML}</body></html>`);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-bg').forEach(m => {
  m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtDate(ts) {
  return new Date(ts).toLocaleDateString('pt-BR',
    {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
}
function fmtTime(ts) {
  return new Date(ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
}
let _tt;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(() => t.classList.remove('show'), 3200);
}

/* Enter to send */
document.getElementById('sector-input').addEventListener('keydown', e => {
  if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendSectorMsg(); }
});
document.getElementById('ticket-chat-inp').addEventListener('keydown', e => {
  if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendTicketMsg(); }
});

/* Init sections on type change */
toggleProblemSections();
</script>
</body>
</html>